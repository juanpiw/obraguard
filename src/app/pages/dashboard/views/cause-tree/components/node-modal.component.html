<div class="modal" [class.modal--open]="open">
  <div class="modal__backdrop" (click)="cancel.emit()"></div>
  <div class="modal__content" role="dialog" aria-modal="true">
    <header class="modal__header">
      <div class="modal__title">
        <h3>{{ mode === 'add' ? 'Añadir causa' : 'Editar hecho' }}</h3>
        <button
          type="button"
          class="ai-btn ai-btn--small"
          [disabled]="!aiEnabled || aiWorking || saving"
          (click)="handleResolveAi()"
          title="Autocompleta esta causa con IA usando el hallazgo como base"
        >
          <span *ngIf="!aiWorking">Resolver con IA</span>
          <span *ngIf="aiWorking">IA...</span>
        </button>
        <small class="ai-error" *ngIf="aiError">{{ aiError }}</small>
      </div>
      <button type="button" class="icon-btn" (click)="cancel.emit()" aria-label="Cerrar">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </header>

    <div class="modal__body">
      <label class="field">
        <span>Descripción del hecho/causa</span>
        <textarea
          [(ngModel)]="text"
          rows="3"
          placeholder="Ej: Fuga de líquido hidráulico"
        ></textarea>
        <small class="helper">
          Regla de oro: en el árbol solo entran <strong>hechos probados</strong>. Evita juicios (“negligencia”) o
          interpretaciones (“estaba distraído”) sin hecho observable.
        </small>
        <div class="warning" *ngIf="showJudgementWarning()">
          <p>
            Esto suena a juicio/interpretación. Reformúlalo a un hecho observable (ej: “miraba el celular”) o guárdalo en
            notas.
          </p>
          <button type="button" class="link-btn" (click)="moveTextToNotes()">Mover a notas</button>
        </div>
      </label>

      <div class="field">
        <span>Clasificación</span>
        <div class="type-grid">
          <button
            type="button"
            class="type-btn"
            [class.type-btn--active]="selectedType === 'Condición'"
            (click)="setType('Condición')"
          >
            Condición
          </button>
          <button
            type="button"
            class="type-btn"
            [class.type-btn--active]="selectedType === 'Acción'"
            (click)="setType('Acción')"
          >
            Acción
          </button>
          <button
            type="button"
            class="type-btn"
            [class.type-btn--active]="selectedType === 'Gestión'"
            (click)="setType('Gestión')"
          >
            Gestión
          </button>
          <button
            type="button"
            class="type-btn"
            [class.type-btn--active]="selectedType === 'Hecho'"
            (click)="setType('Hecho')"
          >
            Hecho
          </button>
        </div>
      </div>

      <div class="field" *ngIf="mode === 'edit'">
        <span>Vinculación lógica entre causas (hijos)</span>
        <div class="type-grid type-grid--two">
          <button
            type="button"
            class="type-btn"
            [class.type-btn--active]="childrenLogic === 'AND'"
            (click)="setChildrenLogic('AND')"
            title="Conjunción: se requieren varios hechos simultáneamente"
          >
            AND
          </button>
          <button
            type="button"
            class="type-btn"
            [class.type-btn--active]="childrenLogic === 'OR'"
            (click)="setChildrenLogic('OR')"
            title="Disyunción: cualquiera de los hechos puede explicar/causar este hecho"
          >
            OR
          </button>
        </div>
      </div>

      <label class="field">
        <span>Notas (interpretaciones/juicios)</span>
        <textarea
          [(ngModel)]="notes"
          rows="2"
          placeholder="Ej: Hipótesis, percepciones del equipo, frases textuales (no comprobadas)."
        ></textarea>
        <small class="helper">Estas notas no se consideran “hechos probados” en el árbol.</small>
      </label>
    </div>

    <footer class="modal__footer">
      <button type="button" class="ghost-btn" (click)="cancel.emit()">Cancelar</button>
      <button type="button" class="primary-btn" [disabled]="saving" (click)="handleSave()">
        <span *ngIf="!saving">Guardar</span>
        <span *ngIf="saving">Guardando...</span>
      </button>
    </footer>
  </div>
</div>


