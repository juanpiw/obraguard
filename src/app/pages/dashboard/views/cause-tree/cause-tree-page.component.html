<section class="cause-page">
  <header class="page-header">
    <div class="page-header__left">
      <p class="eyebrow">Árbol seleccionado: {{ causeTreeId() || 'demo' }}</p>
      <h1>Árbol de Causas</h1>
      <p class="muted">Selecciona un árbol previo o navega con el ID en el query string.</p>
    </div>

    <div class="page-header__actions">
      <button class="ghost" type="button" (click)="resetTree()" [disabled]="loading()">
        Reiniciar
      </button>
      <button
        class="ai-btn"
        type="button"
        [disabled]="aiStatus() === 'working'"
        (click)="generateAiTree()"
      >
        <span *ngIf="aiStatus() !== 'working'">Resolver con IA</span>
        <span *ngIf="aiStatus() === 'working'">Trabajando...</span>
      </button>
      <button class="primary" type="button" (click)="exportPdf()" [disabled]="pdfWorking() || loading()">
        <span *ngIf="!pdfWorking()">Generar PDF</span>
        <span *ngIf="pdfWorking()">Generando...</span>
      </button>
    </div>
  </header>

  <div class="status-bar">
    <div *ngIf="loading()" class="status status--info">Cargando árbol...</div>
    <div *ngIf="error()" class="status status--warn">{{ error() }}</div>
  </div>

  <app-facts-editor
    [tree]="displayTree()"
    [disabled]="loading() || saving()"
    (generate)="onFactsGenerate($event)"
  ></app-facts-editor>

  <app-facts-legend [tree]="displayTree()"></app-facts-legend>

  <app-report-ficha
    [disabled]="loading() || reportLoading() || reportSaving()"
    [ficha]="ficha()"
    (save)="saveFicha($event)"
  ></app-report-ficha>

  <app-report-relato
    [disabled]="loading() || reportLoading() || reportSaving()"
    [relato]="relato()"
    (save)="saveRelato($event)"
  ></app-report-relato>

  <app-report-measures
    [disabled]="loading() || measuresLoading()"
    [measures]="measures()"
    (create)="createMeasure($event)"
    (update)="updateMeasure($event)"
    (remove)="deleteMeasure($event)"
  ></app-report-measures>

  <div class="layout">
    <aside class="history-panel">
      <h4>Historial</h4>
      <div class="history-list">
        <button
          *ngFor="let item of history()"
          type="button"
          [class.history-item--active]="item.id === causeTreeId()"
          class="history-item"
          (click)="selectTree(item.id)"
        >
          <span
            class="history-item__delete"
            role="button"
            tabindex="0"
            (click)="deleteTree(item.id); $event.stopPropagation()"
            (keydown.enter)="deleteTree(item.id); $event.stopPropagation()"
            (keydown.space)="deleteTree(item.id); $event.preventDefault(); $event.stopPropagation()"
            aria-label="Eliminar árbol"
            title="Eliminar árbol"
          >
            Eliminar
          </span>
          <span>#{{ item.id }}</span>
          <small *ngIf="item.hallazgoId">Hallazgo: {{ item.hallazgoId }}</small>
          <small *ngIf="item.updatedAt">{{ item.updatedAt | date: 'short' }}</small>
        </button>
      </div>
    </aside>

    <div class="canvas-wrapper">
      <app-cause-canvas
        [tree]="displayTree()"
        (addNode)="openAdd($event)"
        (editNode)="openEdit($event)"
      ></app-cause-canvas>
    </div>
  </div>

  <app-node-modal
    [open]="modalOpen()"
    [mode]="modalMode()"
    [saving]="saving()"
    [aiEnabled]="!!causeTreeId()"
    [aiWorking]="modalAiWorking()"
    [aiError]="modalAiError()"
    [aiPrefillRequestId]="modalAiPrefillRequestId()"
    [aiPrefillText]="modalAiPrefillText()"
    [aiPrefillType]="modalAiPrefillType()"
    [aiPrefillNotes]="modalAiPrefillNotes()"
    [initialText]="modalInitialText()"
    [initialType]="modalInitialType()"
    [initialNotes]="modalInitialNotes()"
    [initialChildrenLogic]="modalInitialChildrenLogic()"
    (cancel)="closeModal()"
    (resolveAi)="resolveAiFromModal()"
    (save)="saveNode($event)"
  ></app-node-modal>

  <app-ai-toast
    [title]="aiTitle()"
    [message]="aiMessage()"
    [visible]="aiStatus() === 'working'"
  ></app-ai-toast>
</section>
