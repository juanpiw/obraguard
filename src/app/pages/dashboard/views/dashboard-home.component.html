<section class="dashboard-home">
  <div class="dashboard-home__kpis">
    @for (card of kpiCards(); track card.label) {
      <app-kpi-card
        [label]="card.label"
        [value]="card.value"
        [helper]="card.helper"
        [icon]="card.icon"
        [accent]="card.accent"
      />
    }

    <article class="kpi-card iper-list-card">
      <div class="iper-list__header">
        <div>
          <p>IPER generados</p>
          <small>{{ iperFiles().length ? 'Últimos archivos disponibles' : 'Aún no hay IPER generados' }}</small>
        </div>
        <span class="iper-count">{{ iperFiles().length }}</span>
      </div>
      <div class="iper-list">
        @if (iperFiles().length) {
          @for (f of iperFiles(); track f.id) {
            <a class="iper-item" [href]="f.iper_url" target="_blank" rel="noopener">
              <div>
                <p class="iper-item__title">{{ f.titulo || ('IPER #' + f.id) }}</p>
                <small>Obra: {{ f.obraId || 'N/D' }} · Riesgo: {{ f.riesgo || '—' }}</small>
              </div>
              <span class="iper-item__badge">Descargar</span>
            </a>
          }
        } @else {
          <p class="iper-list__empty">Genera un hallazgo con matriz para ver aquí los Excel.</p>
        }
      </div>
    </article>

    <article class="kpi-card kpi-card--blue iper-card" [class.iper-card--highlight]="iperBannerVisible()">
      <div class="kpi-card__top">
        <span>Matriz IPER</span>
        <small class="muted">{{ iperLink() ? 'Última versión disponible' : 'Genera la primera versión' }}</small>
      </div>
      <p class="kpi-card__value">{{ iperLink() ? 'Descarga lista' : 'Sin archivo' }}</p>
      <div class="kpi-card__actions">
        @if (iperLink()) {
          <a class="btn-link" [href]="iperLink()!" target="_blank" rel="noopener">Descargar</a>
          <button type="button" class="btn btn-ghost" (click)="goToPtsArt('pts')">PTS Planificación</button>
          <button type="button" class="btn btn-ghost" (click)="goToPtsArt('art')">ART Gestión Dinámica</button>
        }
        <button type="button" class="btn" (click)="exportIper()" [disabled]="iperExporting()">
          {{ iperExporting() ? 'Generando...' : 'Generar IPER' }}
        </button>
      </div>
      @if (iperBannerVisible()) {
        <div class="iper-banner">
          <span class="iper-banner__dot"></span>
          <div>
            <p class="iper-banner__title">Matriz generada</p>
            <small class="iper-banner__helper">Descarga lista</small>
          </div>
        </div>
      } @else if (iperMessage()) {
        <p class="kpi-card__helper">{{ iperMessage() }}</p>
      } @else {
        <p class="kpi-card__helper">Usa el último obraId detectado para generar Excel.</p>
      }
    </article>
  </div>

  <div class="dashboard-home__analytics">
    <article class="heatmap-card">
      <header>
        <div>
          <h3>Mapa de Calor de Riesgos</h3>
          <p>Vista rápida de los focos críticos en obra.</p>
        </div>
        <div class="heatmap-card__legend">
          <span class="badge badge--red">Alto</span>
          <span class="badge badge--yellow">Medio</span>
        </div>
      </header>

      <div class="heatmap-card__map">
        <iframe
          class="map-frame"
          src="https://www.google.com/maps?q=-33.4489,-70.6693&z=17&t=k&output=embed"
          allowfullscreen
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
          title="Mapa en vivo"
        ></iframe>

        <div class="heatmap-card__overlay">
          <div class="heat-spot heat-spot--red" style="top: 22%; left: 32%;" title="Zona húmeda - Riesgo eléctrico"></div>
          <div class="heat-spot heat-spot--yellow" style="top: 62%; right: 20%;" title="Acopio materiales"></div>
          <div class="heat-spot heat-spot--red" style="bottom: 12%; left: 12%;" title="Excavación abierta"></div>

          <button class="heat-marker heat-marker--red" style="top: 26%; left: 34%;">!</button>
          <button class="heat-marker heat-marker--red" style="bottom: 16%; left: 14%;">!</button>
        </div>
      </div>
      <p class="heatmap-card__hint">Datos en vivo. Punto crítico: Sector B (humedad).</p>
    </article>

    <article class="trend-card">
      <header>
        <div>
          <h3>Tendencia de Seguridad (7 días)</h3>
          <p>Comparativa entre nuevos riesgos y los solucionados por día.</p>
        </div>
      </header>
      <div class="trend-card__chart">
        <svg viewBox="0 0 600 200" preserveAspectRatio="none">
          <line x1="0" y1="200" x2="600" y2="200" stroke="#e5e7eb" stroke-width="2" />
          <line x1="0" y1="0" x2="0" y2="200" stroke="#e5e7eb" stroke-width="2" />

          <polyline fill="none" stroke="#ef4444" stroke-width="3" points="0,150 100,120 200,160 300,80 400,100 500,60 600,90" />
          <g fill="#ef4444">
            <circle cx="0" cy="150" r="4" />
            <circle cx="100" cy="120" r="4" />
            <circle cx="200" cy="160" r="4" />
            <circle cx="300" cy="80" r="4" />
            <circle cx="400" cy="100" r="4" />
            <circle cx="500" cy="60" r="4" />
            <circle cx="600" cy="90" r="4" />
          </g>

          <polyline
            fill="none"
            stroke="#22c55e"
            stroke-width="3"
            stroke-dasharray="5,5"
            points="0,180 100,170 200,140 300,100 400,120 500,80 600,50"
          />
        </svg>
        <div class="trend-card__legend">
          <span><i class="legend-dot legend-dot--red"></i>Nuevos Riesgos</span>
          <span><i class="legend-dot legend-dot--green"></i>Solucionados</span>
        </div>
      </div>
    </article>

    <article class="risk-bars">
      <header>
        <h3>Riesgos por Sector</h3>
        <p>Zonas con mayor densidad de hallazgos abiertos.</p>
      </header>
      <div class="risk-bars__list">
        @for (risk of riskBySector; track risk.label) {
          <div class="risk-row">
            <div class="risk-row__label">
              <span>{{ risk.label }}</span>
              <strong>{{ risk.total }}</strong>
            </div>
            <div class="risk-row__bar">
              <span
                class="risk-row__bar-fill"
                [style.width.%]="risk.percentage"
                [class]="'risk-row__bar-fill--' + risk.color"
              ></span>
            </div>
          </div>
        }
      </div>
    </article>

    <article class="alert-feed">
      <header>
        <h3>Alertas recientes</h3>
        <span class="badge badge--info">Tiempo real</span>
      </header>
      <div class="alert-feed__list">
        @for (alert of criticalAlerts; track alert.title) {
          <div class="alert-feed__item" [class.alert-feed__item--orange]="alert.severity === 'orange'">
            <div>
              <p>{{ alert.title }}</p>
              <small>{{ alert.location }}</small>
            </div>
            <span class="dot" [class.dot--orange]="alert.severity === 'orange'"></span>
          </div>
        }
      </div>
    </article>
  </div>

  <div class="dashboard-home__split">
    <article class="alerts-card">
      <header>
        <h3>
          <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path
              fill-rule="evenodd"
              d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd"
            />
          </svg>
          Atención Inmediata
        </h3>
      </header>
      <div class="alerts-card__list">
        @for (alert of criticalAlerts; track alert.title) {
          <div class="alert-item" [class.alert-item--orange]="alert.severity === 'orange'">
            <p>{{ alert.title }}</p>
            <small>{{ alert.location }}</small>
          </div>
        }
      </div>
    </article>

    <article class="reports-card">
      <header>
        <h3>Últimos Reportes</h3>
        <button type="button">Ver todo</button>
      </header>
      <app-hallazgos-table [hallazgos]="hallazgos()"></app-hallazgos-table>
    </article>
  </div>
</section>

